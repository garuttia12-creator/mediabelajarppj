<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Sertifikat Kelulusan | PJTJ</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        * { box-sizing: border-box; }
        body { margin: 0; background: #eaeaea; font-family: 'Poppins', sans-serif; }
        
        .wrapper { max-width: 1100px; margin: 30px auto; padding: 16px; }
        
        /* Area Sertifikat: Ukuran Standar A4 Landscape */
        .area { 
            width: 297mm;  /* Ukuran Fix A4 Landscape */
            height: 210mm; 
            margin: 0 auto;
            background: #fff; 
            position: relative;
            display: flex; /* Tambahkan ini */
            align-items: center; /* Tambahkan ini untuk center vertikal */
            justify-content: center; /* Tambahkan ini untuk center horizontal */
            overflow: hidden;
        }

        .sertifikat {
            width: 100%;
            height: 100%;
            position: relative;
            /* 1. Ganti background warna putih menjadi gambar */
            background: url('../img/bg-sertifikat.png') no-repeat center center;
            background-size: cover; /* Agar gambar menutupi seluruh area */
            padding: 40px 60px;
            
            /* 2. Opsional: Hilangkan border & outline bawaan jika sudah ada di gambar desain Anda */
            border: none; 
            outline: none;
        }

        /* 3. Opsional: Hilangkan garis emas tipis jika tidak diperlukan */
        .sertifikat::before {
            display: none; 
        }

        .header { text-align: center; margin-bottom: 20px; }
        .logo { display: flex; justify-content: center; gap: 40px; margin-bottom: 15px; align-items: center; }
        .logo img { height: 70px; object-fit: contain; }
        
        h1 { margin: 0; font-family: 'Playfair Display', serif; font-size: 42px; color: #1a237e; letter-spacing: 2px; }
        .nomor { margin-top: 5px; font-size: 14px; color: #555; }
        
        .konten { 
            text-align: center; 
            margin-top: 40px; /* Ditambah agar teks lebih turun ke tengah area yang kosong */
        }
        .nama { font-size: 40px; font-family: 'Playfair Display', serif; font-weight: 700; color: #b8860b; margin: 10px 0; text-transform: capitalize; }
        .garis-nama { width: 60%; height: 2px; background: linear-gradient(90deg, transparent, #333, transparent); margin: 0 auto 15px; }
        
        .keterangan p {
            margin: 0; /* Menghilangkan jarak antar paragraf */
            line-height: 1.5; /* Mengatur jarak antar baris secara otomatis yang nyaman dibaca */
        }
        
        .teks-pengembang p {
            margin: 0; /* Menghilangkan jarak antar paragraf */
            line-height: 1.5; /* Mengatur jarak antar baris secara otomatis yang nyaman dibaca */
        }
        
        .nilai-box { margin: 20px auto; padding: 10px; border: 1px double #d4af37; display: inline-block; min-width: 150px; }
        
        .actions { text-align: center; margin-top: 30px; padding-bottom: 50px; }
        .btn-download {
            padding: 15px 40px; border: none; border-radius: 50px;
            background: linear-gradient(90deg, #1e2f8f, #e93538);
            color: #fff; font-size: 16px; font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.3s;
        }
        .btn-download:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }

        /* Mencegah konflik visual saat konversi */
        @media print {
            .actions { display: none; }
        }
    </style>
</head>
<body>

<div class="wrapper">
    <div id="areaSertifikat" class="area">
        <div class="sertifikat">
           <div class="header">
                <div class="logo">
                    <img src="../img/logo-smkn9.png" alt="Logo Sekolah">
                    <img src="../img/logo-ipigarut.png" alt="Logo IPI">
                </div>
                <h1>SERTIFIKAT KELULUSAN</h1>
                <div class="nomor">Nomor: <span id="noSertifikat">...</span></div>
            </div>
            <div class="konten">
                <p style="margin-bottom: 5px;">Diberikan kepada:</p>
                <div class="nama" id="namaSiswa">Memuat Nama...</div>
                <div class="garis-nama"></div>
                <div class="keterangan">
                    <p>Sebagai bentuk apresiasi atas partisipasi aktif dalam menyelesaikan pembelajaran ini.</p>
                    <p>Nilai akhir yang tercantum merupakan hasil dari proses pembelajan yang telah diikuti</p>
                    <p>Terus belajar, terus berkembang.</p>
                 </div>
                <div class="nilai-box">
                    NILAI RATA-RATA: <b id="nilaiAkhir" style="font-size: 20px;">0</b>
                </div>
                
                <div style="margin-top: 10px; font-size: 14px;">
                    <b>Garut, <span id="tanggal"></span></b>
                </div>

                  <br><br> <div class="teks-pengembang"><p>Dikembangkan oleh : </p>
                      <p><b>Mahasiswa Pendidikan Teknologi Informasi - IPI Garut</b></p>
                      <p>Karlina, Andini Putri Dinanti, Bunga Febi Rahayu</p>
                  </div>
               </div>
            </div>
        </div>
    </div>
    
    <div class="actions">
        <button class="btn-download" onclick="unduhPDF()">
            â¬‡ Unduh Sertifikat (PDF)
        </button>
    </div>
</div>

<script type="module">
    import { db } from "../js/firebase-config.js";
    import { ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const auth = getAuth();

    async function muatDataSertifikat(user) {
    const uid = user.uid;
    try {
        // Ambil data biodata user
        const userSnap = await get(ref(db, `users/${uid}/biodata`));
        // Ambil SEMUA hasil kuis
        const kuisSnap = await get(ref(db, `hasil_kuis`));

        if (!userSnap.exists()) {
            console.error("Biodata tidak ditemukan");
            document.getElementById("namaSiswa").innerText = "Biodata Tidak Ditemukan";
            return;
        }

        const userData = userSnap.val();
        const kuisData = kuisSnap.exists() ? kuisSnap.val() : {};
        
        const role = (userData.role || "siswa").toLowerCase();
        const isStaff = role === "admin" || role === "guru";

        let materiSelesai = 0; 
        let totalNilai = 0;
        
        // Sesuaikan dengan key materi di database Anda (materi1, materi2, dst)
        const daftarMateri = ['materi1', 'materi2', 'materi3', 'materi4'];
        
        daftarMateri.forEach(m => {
            // Pastikan kuisData[m] ada dan kuisData[m][uid] ada
            if (kuisData[m] && kuisData[m][uid]) {
                materiSelesai++; 
                totalNilai += Number(kuisData[m][uid].skor || 0);
            }
        });

        // Hitung rata-rata
        const rataRata = materiSelesai > 0 ? Math.round(totalNilai / materiSelesai) : 0;
        
        // Tampilkan Nama
        const namaFinal = userData.nama || "Siswa PJTJ";
        document.getElementById("namaSiswa").innerText = isStaff ? `${namaFinal} (Preview)` : namaFinal;
        
        // Tampilkan Nilai (Jika admin beri 100 untuk preview)
        document.getElementById("nilaiAkhir").innerText = isStaff ? "100" : rataRata;

        // Atur Nomor Sertifikat & Tanggal
        const date = new Date();
        const uniquePart = uid.slice(0, 5).toUpperCase();
        document.getElementById("noSertifikat").innerText = `SRTF/TPLG/${date.getFullYear()}/${uniquePart}`;
        document.getElementById("tanggal").innerText = date.toLocaleDateString("id-ID", {
            day: "2-digit", month: "long", year: "numeric"
        });

    } catch (error) { 
        console.error("Error Detail:", error);
        document.getElementById("namaSiswa").innerText = "Gagal Memuat Data";
    }
}

    onAuthStateChanged(auth, (user) => {
        if (user) { muatDataSertifikat(user); } 
        else { window.location.href = "../login.html"; }
    });

   window.unduhPDF = function() {
        const element = document.getElementById("areaSertifikat");
        const namaSiswa = document.getElementById("namaSiswa").innerText;
        
        const opt = {
            margin: [0, 0, 0, 0], 
            filename: `Sertifikat_${namaSiswa}.pdf`,
            image: { type: 'jpeg', quality: 1.0 },
            html2canvas: { 
                scale: 2, 
                useCORS: true,
                logging: false,
                letterRendering: true,
                scrollX: 0,
                scrollY: 0
            },
            jsPDF: { 
                unit: "mm", 
                format: "a4", 
                orientation: "landscape",
                compress: true
            }
        };

        // Cara paling aman untuk auto-center
        html2pdf().set(opt).from(element).save();
    }; // <--- Pastikan penutup ini benar
</script>
</body>
</html>










