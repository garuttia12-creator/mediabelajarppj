<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Sertifikat Kelulusan | PJTJ</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { margin: 0; background: #eaeaea; font-family: 'Poppins', sans-serif; }
        .wrapper { max-width: 1100px; margin: 30px auto; padding: 16px; }

        /* A4 Landscape Ratio */
        .area { width: 100%; background: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.2); overflow: hidden; }

        .sertifikat {
            width: 100%;
            aspect-ratio: 297 / 210;
            position: relative;
            background: #fff;
            padding: 40px 60px;
            box-sizing: border-box;
            border: 20px solid #fff;
            outline: 2px solid #e93538;
            outline-offset: -15px;
        }

        /* Ornamen Sudut */
        .sertifikat::before {
            content: ""; position: absolute; inset: 30px;
            border: 1px solid #d4af37; /* Gold color */
            pointer-events: none;
        }

        .watermark {
            position: absolute; bottom: 20px; right: 30px;
            font-size: 10px; color: #999; font-style: italic;
        }

        /* Header */
        .header { text-align: center; margin-bottom: 20px; }
        .logo { display: flex; justify-content: center; gap: 40px; margin-bottom: 15px; align-items: center; }
        .logo img { height: 70px; object-fit: contain; }

        h1 { margin: 0; font-family: 'Playfair Display', serif; font-size: 42px; color: #1a237e; letter-spacing: 2px; }
        .nomor { margin-top: 5px; font-size: 14px; color: #555; }

        /* Konten */
        .konten { text-align: center; margin-top: 30px; }
        .nama { 
            font-size: 40px; 
            font-family: 'Playfair Display', serif;
            font-weight: 700; 
            color: #b8860b; /* Goldenrod */
            margin: 10px 0;
            text-transform: capitalize;
        }
        .garis-nama { width: 60%; height: 2px; background: linear-gradient(90deg, transparent, #333, transparent); margin: 0 auto 15px; }
        .keterangan { max-width: 85%; margin: 0 auto; font-size: 16px; line-height: 1.6; color: #333; }

        .nilai-box {
            margin: 20px auto;
            padding: 10px;
            border: 1px double #d4af37;
            display: inline-block;
            min-width: 150px;
        }

        /* Footer TTD */
        .footer {
            margin-top: 50px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .ttd { width: 250px; font-size: 14px; }
        .ttd img { height: 60px; margin: 5px 0; }
        .nama-ttd { font-weight: 700; border-bottom: 1.5px solid #333; display: inline-block; padding: 0 10px; }
        .nip { font-size: 12px; margin-top: 2px; }

        /* Actions */
        .actions { text-align: center; margin-top: 30px; padding-bottom: 50px; }
        .btn-download {
            padding: 15px 40px; border: none; border-radius: 50px;
            background: linear-gradient(90deg, #1e2f8f, #e93538);
            color: #fff; font-size: 16px; font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.3s;
        }
        .btn-download:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }

        @media print { .actions { display: none; } }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="area" id="areaSertifikat">
        <div class="sertifikat">
            <div class="watermark">Pengembang: Karlina, Andini, Bunga (PTI IPI Garut)</div>

            <div class="header">
                <div class="logo">
                    <img src="../img/logo-smkn9.png" alt="Logo Sekolah">
                    <img src="../img/logo-ipigarut.png" alt="Logo IPI">
                </div>
                <h1>SERTIFIKAT KELULUSAN</h1>
                <div class="nomor">Nomor: <span id="noSertifikat">...</span></div>
            </div>

            <div class="konten">
                <p style="margin-bottom: 5px;">Diberikan kepada:</p>
                <div class="nama" id="namaSiswa">Memuat Nama...</div>
                <div class="garis-nama"></div>

                <div class="keterangan">
                    Telah menyelesaikan dan dinyatakan <b>LULUS</b> pada mata pelajaran <br>
                    <b>Topologi Jaringan</b> melalui media pembelajaran digital berbasis web <br>
                    Tahun Ajaran <b>2025 / 2026</b>
                </div>

                <div class="nilai-box">
                    NILAI AKHIR: <b id="nilaiAkhir" style="font-size: 20px;">0</b>
                </div>

                <div style="margin-top: 10px; font-size: 14px;">
                    Garut, <span id="tanggal"></span>
                </div>
            </div>

            <div class="footer">
                <div class="ttd">
                    Kepala Sekolah SMKN 9 Garut<br>
                    <img src="../img/ttd-kepsek.png" style="opacity: 0.9;"><br>
                    <div class="nama-ttd">Moh Rofik Zen, S.Pd., M.M.Pd</div><br>
                    <div class="nip">NIP. 19640613 199412 1 002</div>
                </div>

                <div class="ttd">
                    Guru Mata Pelajaran<br>
                    <img src="../img/ttd-gurumapel.png" style="opacity: 0.9;"><br>
                    <div class="nama-ttd">Ikeu Suryani, S.Pd.</div><br>
                    <div class="nip">NIP. 199970904202521 2 099</div>
                </div>
            </div>
        </div>
    </div>

    <div class="actions">
        <button class="btn-download" onclick="unduhPDF()">
            <i class="fa-solid fa-file-pdf"></i> â¬‡ Unduh Sertifikat (PDF)
        </button>
    </div>
</div>

<script type="module">
    import { db } from "../js/firebase-config.js";
    import { ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    // Tambahkan import Auth untuk pengecekan real-time
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const auth = getAuth();

    // Fungsi utama untuk memuat data
    async function muatDataSertifikat(user) {
        const uid = user.uid;

        try {
            const userSnap = await get(ref(db, `users/${uid}`));
            
            if (!userSnap.exists()) {
                alert("Profil pengguna tidak ditemukan di database.");
                return;
            }

            const userData = userSnap.val();
            const isAdmin = userData.biodata?.role === "admin";
            
            // LOGIKA AKSES
            if (!isAdmin) {
                // Jika Siswa, cek kelulusan
                const isLulus = userData.lulus_final || localStorage.getItem(`status_lulus_final_${uid}`);
                if (isLulus !== "true" && isLulus !== true) {
                    alert("Akses dibatasi. Selesaikan materi untuk mendapatkan sertifikat.");
                    window.location.href = "laporan-akhir-topologi.html";
                    return;
                }
            }

            // ISI DATA KE HTML
            const namaFinal = userData.biodata?.nama || userData.nama || "Pengguna";
            document.getElementById("namaSiswa").innerText = isAdmin ? `${namaFinal} (Preview Admin)` : namaFinal;
            
            let nilai = localStorage.getItem(`nilai_sertifikat_${uid}`);
            if (isAdmin && (!nilai || nilai === "0")) nilai = "100"; 
            document.getElementById("nilaiAkhir").innerText = nilai || "0";

            // NOMOR SERTIFIKAT & TANGGAL
            const date = new Date();
            const uniquePart = uid.slice(0, 5).toUpperCase();
            document.getElementById("noSertifikat").innerText = `SRTF/TPLG/${date.getFullYear()}/${uniquePart}`;
            document.getElementById("tanggal").innerText = date.toLocaleDateString("id-ID", {
                day: "2-digit", month: "long", year: "numeric"
            });

        } catch (error) {
            console.error("Error:", error);
            alert("Gagal mengambil data dari server.");
        }
    }

    // OBSERVER: Ini akan otomatis mendeteksi login tanpa bergantung pada LocalStorage saja
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // Jika user terdeteksi login di Firebase
            muatDataSertifikat(user);
        } else {
            // Jika benar-benar tidak ada session login
            const backupId = localStorage.getItem("userLogin");
            if (backupId) {
                // Coba gunakan ID dari localStorage jika Auth observer telat
                muatDataSertifikat({ uid: backupId });
            } else {
                alert("Sesi berakhir. Silahkan login kembali.");
                window.location.href = "../login.html";
            }
        }
    });

    window.unduhPDF = function() {
        const element = document.getElementById("areaSertifikat");
        const namaFile = document.getElementById("namaSiswa").innerText.replace(/\s+/g, '_');
        const opt = {
            margin: 0,
            filename: `Sertifikat_${namaFile}.pdf`,
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 3, useCORS: true, logging: false },
            jsPDF: { unit: "mm", format: "a4", orientation: "landscape" }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>

</body>
</html>