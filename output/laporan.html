<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Nilai Akhir | PJTJ</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* ============ RESET & BASE ============ */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
        body {
            min-height: 100vh;
            background: linear-gradient(180deg, #1e2f8f, #0b1c4d);
            color: #fff;
            overflow-x: hidden;
        }

        /* Navbar Dinamis (Sama dengan Dashboard) */
        .navbar { position:fixed; width:100%; top:0; background:rgba(255,255,255,0.1); backdrop-filter:blur(10px); z-index:1000; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.2); }
        .nav-container { max-width:1200px; margin:auto; display:flex; justify-content:space-between; align-items:center; padding:0 20px; }
        .brand { display:flex; align-items:center; gap:10px; }
        .logo { width: clamp(35px, 10vw, 45px); }
        .brand-text h1 { font-size: clamp(14px, 4vw, 18px); margin:0; }
        .brand-text span { font-size: clamp(10px, 3vw, 12px); opacity:0.8; }
        
        nav ul { display:flex; list-style:none; gap:15px; align-items: center; }
        nav a { color:#fff; text-decoration:none; font-size: clamp(12px, 3vw, 14px); font-weight:500; transition: 0.3s; }
        nav a:hover { opacity: 0.8; }
        .active { color: #ff6f61 !important; }

        /* Style Khusus Tombol Admin */
        .btn-admin {
            background: #f8c471;
            color: #0b1c4d !important;
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: 700 !important;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ============ KONTEN LAPORAN ============ */
        .container { width: 100%; max-width: 900px; margin: auto; padding: 120px 15px 60px; }
        .card { 
            background: rgba(255, 255, 255, 0.1); border-radius: 22px; padding: 25px; 
            border: 1px solid rgba(255, 255, 255, .15); backdrop-filter: blur(10px); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }
        .table-container { width: 100%; overflow-x: auto; margin-top: 20px; }
         table { width: 100%; border-collapse: collapse; min-width: 600px; }
        thead th { padding: 15px; background: rgba(255, 255, 255, .1); text-align: center; color: #f8c471; font-size: 14px; }
        td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, .05); font-size: 14px; }
        
        .nilai-besar {
            font-size: 70px; font-weight: 800; margin: 10px 0;
            background: linear-gradient(90deg, #ff9a3c, #ff3d3d);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .blok-header { background: rgba(248, 196, 113, 0.1); font-weight: bold; color: #f8c471; text-align: left !important; }
        .sub-total { background: rgba(76, 201, 240, 0.1); font-weight: bold; color: #4cc9f0; }

        #btnSertifikat {
            background: linear-gradient(90deg, #27ae60, #2ecc71); color: white; border: none;
            padding: 15px 30px; border-radius: 30px; font-weight: bold; cursor: pointer;
            margin-top: 20px; display: none; text-decoration: none;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4); transition: 0.3s;
        }
        #btnSertifikat:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(39, 174, 96, 0.6); }

        @media(max-width: 600px) {
            .container { padding-top: 100px; }
            .nilai-besar { font-size: 50px; }
        }
    </style>
</head>
<body>

<header class="navbar">
    <div class="nav-container">
        <div class="brand">
            <img src="../img/logo-smkn9.png" class="logo">
            <div class="brand-text">
                <h1>SMKN 9 Garut</h1>
                <span>Media Pembelajaran TJKT</span>
            </div>
        </div>
        <nav>
            <ul>
                <li><a href="../dashboard.html">Dashboard</a></li>
                <li id="admin-link"></li> 
                <li><a href="#" id="btnLogout">Logout</a></li>
            </ul>
        </nav>
    </div>
</header>

<div class="container">
    <div class="card">
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="margin:0; font-size: 24px;">üìò Laporan Hasil Belajar</h1>
            <p style="opacity: 0.7; font-size: 14px;">Akumulasi nilai akhir materi </p>
            <div id="nilaiAkhir" class="nilai-besar">0</div>
            <p id="statusTeks" style="font-size: 18px; font-weight: 500;"></p>
            <a href="sertifikat.html" id="btnSertifikat">üéì DOWNLOAD SERTIFIKAT</a>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 50px;">NO</th>
                        <th style="text-align: left;">INDIKATOR</th>
                        <th>Skor Anda</th>
                    </tr>
                </thead>
                <tbody id="tabelBody">
                    <tr><td colspan="3" style="padding: 50px;">Sedang memvalidasi data siswa...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { db, auth } from "../js/firebase-config.js";
    import { ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Handle Auth & Header Logic
    onAuthStateChanged(auth, (user) => {
        if (user) {
            loadHeaderData(user.uid);
            ambilDataSiswa(user.uid);
        } else {
            window.location.href = "../login.html";
        }
    });

    // Logout Logic
    document.getElementById('btnLogout').addEventListener('click', (e) => {
        e.preventDefault();
        if(confirm("Apakah Anda yakin ingin keluar?")) {
            signOut(auth).then(() => {
                localStorage.clear();
                window.location.href = "../login.html";
            });
        }
    });

    async function loadHeaderData(uid) {
        try {
            const snap = await get(ref(db, `users/${uid}/biodata`));
            if (snap.exists()) {
                const data = snap.val();
                const role = (data.role || "").toLowerCase();
                // Otorisasi: Admin dan Guru memiliki akses yang sama ke link CMS
                if (role === "admin" || role === "guru") {
                    document.getElementById("admin-link").innerHTML = `
                        <a href="../admin/admin-cms.html" class="btn-admin">
                            <i class="fa-solid fa-user-shield"></i>Guru
                        </a>`;
                }
            }
        } catch (e) { console.error(e); }
    }

    async function ambilDataSiswa(uid) {
        try {
            const [materiSnap, userSnap] = await Promise.all([
                get(ref(db, 'materi')),
                get(ref(db, `users/${uid}/progres`))
            ]);

            const tbody = document.getElementById('tabelBody');
            if (!materiSnap.exists()) {
                tbody.innerHTML = "<tr><td colspan='3'>Belum ada daftar materi.</td></tr>";
                return;
            }

            const materiData = materiSnap.val();
            const progresData = userSnap.val() || {};
            const listMateri = Object.keys(materiData).map(key => ({
                id_db: key,
                ...materiData[key]
            })).sort((a, b) => (a.id_urut || 0) - (b.id_urut || 0));

            tbody.innerHTML = "";
            let totalSkorKumulatif = 0;
            let blokSelesaiCount = 0;

            for (let i = 0; i < listMateri.length; i += 4) {
                const group = listMateri.slice(i, i + 4);
                const nomorBlok = Math.floor(i / 4) + 1;

                const hRow = document.createElement('tr');
                hRow.className = 'blok-header';
                hRow.innerHTML = `<td colspan="3"><i class="fa-solid fa-layer-group"></i> MERANCANG TOPOLOGI JARINGAN ${nomorBlok}</td>`;
                tbody.appendChild(hRow);

                let skorBlok = 0;
                let materiTuntas = 0;

                group.forEach(m => {
                    const p = progresData[m.id_db];
                    const skor = (p && p.skor !== undefined) ? parseInt(p.skor) : null;
                    if (skor !== null) {
                        skorBlok += skor;
                        materiTuntas++;
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${m.id_urut || '-'}</td>
                        <td style="text-align: left;">${m.judul}</td>
                        <td style="font-weight:bold; color:${skor >= 70 ? '#2ecc71' : '#ff6f61'}">
                            ${skor !== null ? skor : '<span style="opacity:0.3">Belum Ada</span>'}
                        </td>`;
                    tbody.appendChild(row);
                });

                const fRow = document.createElement('tr');
                fRow.className = 'sub-total';
                if (materiTuntas === group.length && group.length > 0) {
                    const rataRata = Math.round(skorBlok / group.length);
                    fRow.innerHTML = `<td colspan="2">RATA-RATA MATERI ${nomorBlok}</td><td>${rataRata}</td>`;
                    totalSkorKumulatif += rataRata;
                    blokSelesaiCount++;
                } else {
                    fRow.innerHTML = `<td colspan="2">RATA-RATA MATERI ${nomorBlok}</td><td style="font-size:11px; color:#f8c471">Belum Lengkap (${materiTuntas}/${group.length})</td>`;
                }
                tbody.appendChild(fRow);
            }

            const nilaiFinal = blokSelesaiCount > 0 ? Math.round(totalSkorKumulatif / blokSelesaiCount) : 0;
            document.getElementById('nilaiAkhir').innerText = nilaiFinal;

            const statusTeks = document.getElementById('statusTeks');
            const btnSertif = document.getElementById('btnSertifikat');

            if (blokSelesaiCount >= 1 && nilaiFinal >= 70) {
                statusTeks.innerHTML = "‚úÖ Selamat Anda Lulus!";
                statusTeks.style.color = "#2ecc71";
                btnSertif.style.display = "inline-block";
            } else {
                statusTeks.innerHTML = "‚ùå Belum Memenuhi Syarat Kelulusan (Minimal Skor 70)";
                statusTeks.style.color = "#f8c471";
                btnSertif.style.display = "none";
            }

        } catch (error) {
            console.error(error);
            document.getElementById('tabelBody').innerHTML = `<tr><td colspan="3" style="color:red">Terjadi kesalahan memuat data.</td></tr>`;
        }
    }
</script>

</body>
</html>
